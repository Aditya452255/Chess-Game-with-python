<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chess — Combined Modern UI</title>

  <style>
    :root{
      --bg:#0f1113;
      --card:#111317;
      --muted:#9aa6ad;
      --accent:#0ea5a4;
      --neon: 0 10px 30px rgba(14,165,164,0.12), 0 2px 6px rgba(14,165,164,0.06);
      --light-square:#e9e6df;
      --dark-square:#7aa3a6;
      --glass: rgba(255,255,255,0.02);
      --text:#e6eef2;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial
    }

    body{
      background:var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px
    }

    .app-wrap{
      width:1100px;
      max-width:calc(100% - 48px);
      display:flex;
      gap:28px
    }

    .card{
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.05));
      border-radius:18px;
      padding:20px;
      box-shadow:0 8px 30px rgba(0,0,0,0.7),inset 0 1px 0 rgba(255,255,255,0.02)
    }

    .board-card{ flex:1; min-width:520px; padding:22px }

    /* Title bar */
    .title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px
    }

    .title-left{
      display:flex;
      align-items:center;
      gap:12px
    }

    .title-left h1{
      font-size:20px;
      margin:0
    }

    .title-left small{
      color:var(--muted);
      font-size:13px
    }

    .icon-btn{
      width:36px;
      height:36px;
      border-radius:10px;
      background:linear-gradient(180deg,#16181a,#0d0f10);
      display:inline-grid;
      place-items:center;
      border:1px solid rgba(255,255,255,0.02);
      box-shadow:0 3px 8px rgba(0,0,0,0.6),inset 0 2px 0 rgba(255,255,255,0.02);
      cursor:pointer
    }

    /* Board */
    #board{
      display:grid;
      grid-template-columns:repeat(8,1fr);
      gap:6px;
      padding:12px;
      border-radius:12px;
      background:linear-gradient(180deg,rgba(0,0,0,0.12),rgba(0,0,0,0.04));
      box-shadow:inset 0 6px 20px rgba(0,0,0,0.6)
    }

    .cell{
      position:relative;
      border-radius:8px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center
    }

    .cell .coord{
      position:absolute;
      left:6px;
      top:6px;
      font-size:12px;
      color:var(--muted);
      opacity:0.8
    }

    .cell img{
      width:72%;
      height:auto;
      user-drag:none;
      user-select:none;
      cursor:grab
    }

    /* Sidebar */
    .sidebar{
      width:320px;
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:18px
    }

    .stat-row{ display:flex; gap:12px }

    .stat-box{
      background:linear-gradient(180deg,#0f1517,#0b0d0e);
      padding:12px;
      border-radius:10px;
      min-width:80px;
      text-align:center;
      box-shadow:var(--neon)
    }

    .stat-box small{
      display:block;
      color:var(--muted);
      font-size:12px
    }

    .stat-box strong{
      display:block;
      font-size:18px;
      margin-top:6px
    }

    .controls{
      display:flex;
      flex-direction:column;
      gap:10px
    }

    .btn{
      padding:10px 14px;
      border-radius:12px;
      border:0;
      background:linear-gradient(180deg,#0f9ea1,#0d7f83);
      color:#041516;
      font-weight:700;
      cursor:pointer;
      box-shadow:var(--neon)
    }

    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid rgba(255,255,255,0.03);
      box-shadow:none
    }

    .score{
      background:linear-gradient(90deg,#10343a,#1e6a6d);
      border-radius:14px;
      padding:18px;
      text-align:center;
      color:var(--accent);
      font-weight:800;
      box-shadow:var(--neon)
    }

    .options{
      display:flex;
      flex-direction:column;
      gap:8px
    }

    .row{
      display:flex;
      align-items:center;
      gap:10px
    }

    .label{
      color:var(--muted);
      font-size:13px
    }

    input[type=checkbox]{ transform:scale(1.05) }

    @media(max-width:1100px){
      .app-wrap{ flex-direction:column; width:100%; align-items:center }
      .sidebar{ width:100% }
      .board-card{ width:100% }
      #board{ gap:4px }
    }
  </style>

</head>
<body>

  <div class="app-wrap">

    <!-- Board -->
    <div class="card board-card">
      <div class="title-row">
        <div class="title-left">
          <h1>Chess</h1>
          <small>Modern neon board — drag pieces to move</small>
        </div>

        <div class="title-actions">
          <div class="icon-btn" id="resetIcon">⟲</div>
          <div class="icon-btn" id="flipBoard">↕</div>
        </div>
      </div>

      <div id="board"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar card">

      <div class="stat-row">
        <div class="stat-box"><small>TIMER</small><strong id="timer">00:00</strong></div>
        <div class="stat-box"><small>TURN</small><strong id="turnText">White</strong></div>
        <div class="stat-box"><small>CAPTURED</small><strong id="capturedCount">0</strong></div>
      </div>

      <div class="controls">

        <div style="display:flex;gap:10px">
          <button class="btn" id="newGame">New Game</button>
          <button class="btn ghost" id="undo">Undo</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <label class="label">Board size</label>
          <select id="boardSize">
            <option value="640">640px</option>
            <option value="520">520px</option>
            <option value="420">420px</option>
          </select>
        </div>

        <div class="score">
          <div class="label">STATUS</div>
          <div id="statusValue" style="font-size:18px;margin-top:6px;color:var(--accent);">Ready</div>
        </div>

        <div>
          <div class="label" style="margin-bottom:8px">Options</div>

          <div class="options">
            <label class="row"><input type="checkbox" id="showCoords" checked> Show coordinates</label>
          </div>

        </div>
      </div>

    </aside>
  </div>

<script>
/* ======================================================
   Chess Front-end Logic (No backend needed for demo)
====================================================== */

const boardEl = document.getElementById("board");
const turnText = document.getElementById("turnText");
const timerEl = document.getElementById("timer");
const capturedCount = document.getElementById("capturedCount");

let boardSize = 640;
let flipped = false;
let timerInterval = null;
let seconds = 0;

/* ======================================================
   TIMER
====================================================== */
function startTimer() {
  clearInterval(timerInterval);
  seconds = 0;
  timerEl.textContent = "00:00";

  timerInterval = setInterval(() => {
    seconds++;
    let m = String(Math.floor(seconds / 60)).padStart(2, "0");
    let s = String(seconds % 60).padStart(2, "0");
    timerEl.textContent = m + ":" + s;
  }, 1000);
}

startTimer();

/* ======================================================
   BOARD SETUP
====================================================== */
function setBoardPixelSize(px) {
  boardSize = parseInt(px);
  boardEl.style.width = boardSize + "px";
  boardEl.style.height = boardSize + "px";

  const s = boardSize / 8;
  document.querySelectorAll(".cell").forEach(c => {
    c.style.width = s + "px";
    c.style.height = s + "px";
  });
}

function createBoardGrid() {
  boardEl.innerHTML = "";

  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.row = r;
      cell.dataset.col = c;

      const coord = document.createElement("div");
      coord.className = "coord";
      coord.textContent = `${"abcdefgh"[c]}${8 - r}`;
      cell.appendChild(coord);

      cell.addEventListener("dragover", e => e.preventDefault());
      cell.addEventListener("drop", onDrop);

      boardEl.appendChild(cell);
    }
  }

  applySquareColors();
  setBoardPixelSize(boardSize);
}

/* ======================================================
   PIECES (fetched from server)
   We'll request `/api/state` to get the authoritative board and moves.
====================================================== */

let pieces = [];

async function loadState() {
  try {
    const res = await fetch('/api/state');
    const json = await res.json();
    pieces = json.board.pieces.map(p => ({ row: p.row, col: p.col, color: p.color, name: p.name }));
    turnText.textContent = json.next_player[0].toUpperCase() + json.next_player.slice(1);
    renderPieces();
  } catch (e) {
    console.error('Failed to load state', e);
  }
}

function pieceNameToFile(color, name) {
  // map short codes to asset filenames
  const cmap = { w: 'white', b: 'black' };
  const nmap = { r: 'rook', n: 'knight', b: 'bishop', q: 'queen', k: 'king', p: 'pawn' };
  return `/assets/images/imgs-80px/${cmap[color]}_${nmap[name]}.png`;
}

/* ======================================================
   RENDER PIECES
====================================================== */

function renderPieces() {
  document.querySelectorAll(".cell").forEach(cell => cell.innerHTML = `
    <div class="coord">${"abcdefgh"[cell.dataset.col]}${8 - cell.dataset.row}</div>
  `);

  pieces.forEach(p => {
    const selector = `.cell[data-row="${p.row}"][data-col="${p.col}"]`;
    const cell = document.querySelector(selector);
    if (!cell) return;

    const img = document.createElement("img");
    // Map short names to asset filenames and use local assets
    const nameMap = { p: 'pawn', r: 'rook', n: 'knight', b: 'bishop', q: 'queen', k: 'king' };
    const colorMap = { w: 'white', b: 'black' };
    const longName = nameMap[p.name] || p.name;
    const colorLong = colorMap[p.color] || p.color;
    // Use images shipped inside `web/static/images` so Flask serves them at /static/...
    const localPath = `/static/images/imgs-80px/${colorLong}_${longName}.png`;
    img.src = localPath;
    img.draggable = true;

    img.dataset.row = p.row;
    img.dataset.col = p.col;

    img.addEventListener("dragstart", onDragStart);

    cell.appendChild(img);
  });
}

/* ======================================================
   APPLY COLORS
====================================================== */
function applySquareColors() {
  document.querySelectorAll(".cell").forEach(cell => {
    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);

    const isLight = (r + c) % 2 === 0;

    cell.style.background = isLight
      ? "var(--light-square)"
      : "var(--dark-square)";

    if (document.getElementById("neonGlow").checked) {
      cell.style.boxShadow = "inset 0 -30px 30px rgba(0,0,0,0.25)";
    }
  });
}

/* ======================================================
   DRAG AND DROP
====================================================== */

function onDragStart(e) {
  const img = e.target;
  e.dataTransfer.setData(
    "text/plain",
    JSON.stringify({
      row: img.dataset.row,
      col: img.dataset.col
    })
  );
}

function onDrop(e) {
  e.preventDefault();
  const data = JSON.parse(e.dataTransfer.getData("text/plain"));
  const dest = e.currentTarget;

  const initial_row = parseInt(data.row);
  const initial_col = parseInt(data.col);
  const final_row = parseInt(dest.dataset.row);
  const final_col = parseInt(dest.dataset.col);

  // POST move to server
  fetch('/api/move', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ initial_row, initial_col, final_row, final_col })
  }).then(r => r.json()).then(json => {
    if (!json.ok) {
      alert('Move failed: ' + (json.error || 'unknown'));
      return;
    }
    // update local pieces from server response
    pieces = json.board.pieces;
    turnText.textContent = json.next_player[0].toUpperCase() + json.next_player.slice(1);
    renderPieces();
  }).catch(err => {
    console.error(err);
    alert('Server error');
  });
}

/* ======================================================
   BUTTON ACTIONS
====================================================== */

document.getElementById("resetIcon").addEventListener("click", async () => {
  await fetch('/api/reset', { method: 'POST' });
  await loadState();
});

document.getElementById("flipBoard").addEventListener("click", () => {
  flipped = !flipped;
  boardEl.style.transform = flipped ? "rotate(180deg)" : "none";
});

document.getElementById("newGame").addEventListener("click", async () => {
  await fetch('/api/reset', { method: 'POST' });
  await loadState();
});

document.getElementById("undo").addEventListener("click", async () => {
  try {
    const res = await fetch('/api/undo', { method: 'POST' });
    const json = await res.json();
    if (!json.ok) {
      alert('Undo failed: ' + (json.error || 'none'));
      return;
    }
    pieces = json.board.pieces;
    turnText.textContent = json.next_player[0].toUpperCase() + json.next_player.slice(1);
    renderPieces();
  } catch (e) {
    console.error('Undo error', e);
    alert('Server error during undo');
  }
});

document.getElementById("boardSize").addEventListener("change", e => {
  setBoardPixelSize(e.target.value);
});

document.getElementById("neonGlow").addEventListener("change", applySquareColors);

document.getElementById("showCoords").addEventListener("change", () => {
  const display = document.getElementById("showCoords").checked ? "block" : "none";
  document.querySelectorAll(".coord").forEach(c => c.style.display = display);
});

/* ======================================================
   INIT
====================================================== */
async function loadState(){
  try{
    const res = await fetch('/api/state');
    const json = await res.json();
    pieces = json.board.pieces;
    turnText.textContent = json.next_player[0].toUpperCase() + json.next_player.slice(1);
    createBoardGrid();
    renderPieces();
  }catch(e){
    console.error('Failed to load state', e);
  }
}

createBoardGrid();
loadState();
startTimer();
</script>

</body>
</html>
